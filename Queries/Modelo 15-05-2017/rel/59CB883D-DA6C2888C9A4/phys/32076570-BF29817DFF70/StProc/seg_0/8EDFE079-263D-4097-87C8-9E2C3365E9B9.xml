<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.StoredProcedureOraclev10g" name="GET_PRESUP_POR_SEDE" directorySegmentName="seg_0" id="8EDFE079-263D-4097-87C8-9E2C3365E9B9">
<sourceConnName>Desarrollo2</sourceConnName>
<sourceObjSchema>CONSULTOR3</sourceObjSchema>
<sourceObjName>GET_PRESUP_POR_SEDE</sourceObjName>
<createdBy>consultor3</createdBy>
<createdTime>2017-05-16 03:15:38 UTC</createdTime>
<ownerDesignName>Modelo 15-05-2017</ownerDesignName>
<owner>AE2292FC-43E2-FF51-8677-819EDD136431</owner>
<source>CREATE OR REPLACE PROCEDURE CONSULTOR3.GET_PRESUP_POR_SEDE (VAR_ID_SEDE IN NUMBER,CUR_RPTA OUT sys_refcursor)IS&lt;br/&gt;BEGIN&lt;br/&gt;&lt;br/&gt;    SAVEPOINT obtenerResultados;&lt;br/&gt;&lt;br/&gt;    OPEN CUR_RPTA FOR&lt;br/&gt;&lt;br/&gt;        select e.ID_PRESUPUESTO as id_presupuesto,&lt;br/&gt;        max(e.fecha_reg) as fecha_reg,&lt;br/&gt;        max(e.usuario_reg) as usuario_reg,        &lt;br/&gt;        NVL(sum(d.TOTAL_SOLIC),0) as monto,&lt;br/&gt;        NVL(max(d.DET_V_ULT_FEC),NVL(max(a.V_ULT_MODIF_FEC),max(e.ULT_MODIF_FEC))) as ult_modif_fec,&lt;br/&gt;        max(e.ult_modif_user) as ult_modif_user, &lt;br/&gt;        NVL(min(a.V_FECHA_VAL_INI),min(e.FECHA_VAL_INI)) as fecha_val_ini,&lt;br/&gt;        NVL(max(a.V_FECHA_VAL_FIN),max(e.FECHA_VAL_FIN)) as fecha_val_fin,&lt;br/&gt;        max(e.est_actual) as est_actual,&lt;br/&gt;        max(e.nomb_presup) as nomb_presup&lt;br/&gt;        from &lt;br/&gt;        t_version a&lt;br/&gt;        inner join t_det_presup c on a.ID_DET_PRESUP=c.ID_DET_PRESUP&lt;br/&gt;        left join T_DET_VERSION d on a.ID_VERSION=d.ID_VERSION&lt;br/&gt;        inner join&lt;br/&gt;        (SELECT&lt;br/&gt;            max(nro) as nro,&lt;br/&gt;            ID_DET_PRESUP,&lt;br/&gt;            id_area&lt;br/&gt;        FROM&lt;br/&gt;            t_version &lt;br/&gt;            group by ID_DET_PRESUP,id_area) b &lt;br/&gt;            on a.nro=b.nro and a.ID_DET_PRESUP=b.ID_DET_PRESUP and a.id_area=b.id_area&lt;br/&gt;            right join t_presup e  on e.ID_PRESUPUESTO=c.ID_PRESUPUESTO&lt;br/&gt;            group by e.ID_PRESUPUESTO&lt;br/&gt;			order by max(e.fecha_reg) desc;&lt;br/&gt;&lt;br/&gt;&lt;br/&gt;    EXCEPTION &lt;br/&gt;        WHEN OTHERS THEN&lt;br/&gt;&lt;br/&gt;            ROLLBACK TO obtenerResultados;&lt;br/&gt;            RAISE;&lt;br/&gt;END;</source>
<body>CREATE OR REPLACE PROCEDURE CONSULTOR3.GET_PRESUP_POR_SEDE (VAR_ID_SEDE IN NUMBER,CUR_RPTA OUT sys_refcursor)IS&lt;br/&gt;BEGIN&lt;br/&gt;&lt;br/&gt;    SAVEPOINT obtenerResultados;&lt;br/&gt;&lt;br/&gt;    OPEN CUR_RPTA FOR&lt;br/&gt;&lt;br/&gt;        select e.ID_PRESUPUESTO as id_presupuesto,&lt;br/&gt;        max(e.fecha_reg) as fecha_reg,&lt;br/&gt;        max(e.usuario_reg) as usuario_reg,        &lt;br/&gt;        NVL(sum(d.TOTAL_SOLIC),0) as monto,&lt;br/&gt;        NVL(max(d.DET_V_ULT_FEC),NVL(max(a.V_ULT_MODIF_FEC),max(e.ULT_MODIF_FEC))) as ult_modif_fec,&lt;br/&gt;        max(e.ult_modif_user) as ult_modif_user, &lt;br/&gt;        NVL(min(a.V_FECHA_VAL_INI),min(e.FECHA_VAL_INI)) as fecha_val_ini,&lt;br/&gt;        NVL(max(a.V_FECHA_VAL_FIN),max(e.FECHA_VAL_FIN)) as fecha_val_fin,&lt;br/&gt;        max(e.est_actual) as est_actual,&lt;br/&gt;        max(e.nomb_presup) as nomb_presup&lt;br/&gt;        from &lt;br/&gt;        t_version a&lt;br/&gt;        inner join t_det_presup c on a.ID_DET_PRESUP=c.ID_DET_PRESUP&lt;br/&gt;        left join T_DET_VERSION d on a.ID_VERSION=d.ID_VERSION&lt;br/&gt;        inner join&lt;br/&gt;        (SELECT&lt;br/&gt;            max(nro) as nro,&lt;br/&gt;            ID_DET_PRESUP,&lt;br/&gt;            id_area&lt;br/&gt;        FROM&lt;br/&gt;            t_version &lt;br/&gt;            group by ID_DET_PRESUP,id_area) b &lt;br/&gt;            on a.nro=b.nro and a.ID_DET_PRESUP=b.ID_DET_PRESUP and a.id_area=b.id_area&lt;br/&gt;            right join t_presup e  on e.ID_PRESUPUESTO=c.ID_PRESUPUESTO&lt;br/&gt;            group by e.ID_PRESUPUESTO&lt;br/&gt;			order by max(e.fecha_reg) desc;&lt;br/&gt;&lt;br/&gt;&lt;br/&gt;    EXCEPTION &lt;br/&gt;        WHEN OTHERS THEN&lt;br/&gt;&lt;br/&gt;            ROLLBACK TO obtenerResultados;&lt;br/&gt;            RAISE;&lt;br/&gt;END;</body>
</StoredProcedureOraclev10g>