<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.StoredProcedureOraclev10g" name="NEW_PRESUP" directorySegmentName="seg_0" id="35EA3781-59BD-4D70-C6BD-D1ED40390EF7">
<sourceConnName>Desarrollo2</sourceConnName>
<sourceObjSchema>CONSULTOR3</sourceObjSchema>
<sourceObjName>NEW_PRESUP</sourceObjName>
<createdBy>consultor3</createdBy>
<createdTime>2017-05-16 03:15:38 UTC</createdTime>
<ownerDesignName>Modelo 15-05-2017</ownerDesignName>
<owner>AE2292FC-43E2-FF51-8677-819EDD136431</owner>
<source>CREATE OR REPLACE PROCEDURE CONSULTOR3.NEW_PRESUP (&lt;br/&gt;  VAR_NOMBRE IN VARCHAR2, &lt;br/&gt;  VAR_ID_SEDE IN NUMBER, &lt;br/&gt;  VAR_USUARIO_REG IN VARCHAR2, &lt;br/&gt;  MES_DESDE IN NUMBER, &lt;br/&gt;  ANIO_DESDE IN NUMBER,&lt;br/&gt;  MES_HASTA IN NUMBER,&lt;br/&gt;  ANIO_HASTA IN NUMBER,&lt;br/&gt;  CUR_RPTA OUT SYS_REFCURSOR) AS&lt;br/&gt;  &lt;br/&gt;  VAR_NUMERO_PRESUPS NUMBER;&lt;br/&gt;  VAR_ID_PRESUP_INS NUMBER(22,0);&lt;br/&gt;  VAR_FECHA_DESDE DATE;&lt;br/&gt;  VAR_FECHA_HASTA DATE;&lt;br/&gt;  VAR_NEW_FECHA_HASTA DATE;&lt;br/&gt;&lt;br/&gt;BEGIN&lt;br/&gt;&lt;br/&gt;    SAVEPOINT obtenerResultados;&lt;br/&gt;	&lt;br/&gt;	--OBTIENE EL ULTIMO PRESUPUESTO&lt;br/&gt;    SELECT COUNT(ID_PRESUPUESTO) INTO VAR_NUMERO_PRESUPS &lt;br/&gt;    FROM T_PRESUP WHERE rownum &lt;= 5;&lt;br/&gt;    &lt;br/&gt;     -- OBTIENE LA FECHA DEL PRIMER DIA DEL MES Y AÃ`O PARA FECHA DE INICIO&lt;br/&gt;    SELECT TO_DATE(CONCAT(CONCAT(CONCAT(&apos;01/&apos;,MES_DESDE),&apos;/&apos;),ANIO_DESDE),&apos;dd/mm/yyyy&apos;) INTO VAR_FECHA_DESDE FROM DUAL;&lt;br/&gt;    -- OBTIENE LA FECHA DEL ULTIMO DIA DEL MES Y AÃ`O PARA FECHA DE FIN&lt;br/&gt;    SELECT LAST_DAY(TO_DATE(CONCAT(CONCAT(CONCAT(&apos;01/&apos;,MES_HASTA),&apos;/&apos;),ANIO_HASTA),&apos;dd/mm/yyyy&apos;)) INTO VAR_FECHA_HASTA FROM DUAL;&lt;br/&gt;    --OBTIENE LA FECHA CON EL ULTIMO DÃ¿A DEL MES ANTERIOR AL INICIO DEL PERIODO SOLICITADO&lt;br/&gt;    SELECT LAST_DAY(ADD_MONTHS(VAR_FECHA_DESDE,-1)) INTO VAR_NEW_FECHA_HASTA FROM DUAL;&lt;br/&gt;    &lt;br/&gt;    IF(VAR_NUMERO_PRESUPS&gt;0) THEN&lt;br/&gt;    &lt;br/&gt;        SELECT A.ID_PRESUPUESTO INTO VAR_ID_PRESUP_INS &lt;br/&gt;        FROM T_PRESUP A &lt;br/&gt;        WHERE A.FECHA_REG=(SELECT MAX(FECHA_REG) FROM T_PRESUP);&lt;br/&gt;        &lt;br/&gt;        IF(NVL(VAR_ID_PRESUP_INS,0)&lt;&gt;0) THEN&lt;br/&gt;    &lt;br/&gt;           &lt;br/&gt;        &lt;br/&gt;            -- ACTUALIZA EL ULTIMO PRESUPUESTO Y SUS DETALLES CON LAS FECHAS&lt;br/&gt;    &lt;br/&gt;            UPDATE T_VERSION&lt;br/&gt;            SET V_FECHA_VAL_FIN=VAR_NEW_FECHA_HASTA,&lt;br/&gt;            V_ULT_MODIF_FEC=SYSDATE,&lt;br/&gt;            V_ULT_MOD_USR=VAR_USUARIO_REG&lt;br/&gt;            where ID_VERSION IN &lt;br/&gt;            (SELECT A.ID_VERSION &lt;br/&gt;            FROM T_VERSION A &lt;br/&gt;            INNER JOIN T_DET_PRESUP B ON A.ID_DET_PRESUP=B.ID_DET_PRESUP&lt;br/&gt;            INNER JOIN T_PRESUP C ON B.ID_PRESUPUESTO=C.ID_PRESUPUESTO&lt;br/&gt;            WHERE C.ID_PRESUPUESTO=VAR_ID_PRESUP_INS);&lt;br/&gt;            &lt;br/&gt;            UPDATE T_DET_PRESUP&lt;br/&gt;            SET DET_P_FECHA_VAL_FIN=VAR_NEW_FECHA_HASTA,&lt;br/&gt;            DET_P_ULT_MODIF_FEC=SYSDATE,&lt;br/&gt;            DET_P_MODIF_USR=VAR_USUARIO_REG	&lt;br/&gt;            WHERE (ID_DET_PRESUP) IN(&lt;br/&gt;            SELECT&lt;br/&gt;            (B.ID_DET_PRESUP) &lt;br/&gt;            FROM&lt;br/&gt;            T_DET_PRESUP B &lt;br/&gt;            INNER JOIN T_PRESUP C ON B.ID_PRESUPUESTO=C.ID_PRESUPUESTO&lt;br/&gt;            WHERE C.ID_PRESUPUESTO=VAR_ID_PRESUP_INS);&lt;br/&gt;            &lt;br/&gt;            UPDATE T_PRESUP&lt;br/&gt;            SET FECHA_VAL_FIN=VAR_NEW_FECHA_HASTA,&lt;br/&gt;            ULT_MODIF_FEC=SYSDATE,&lt;br/&gt;            ULT_MODIF_USER=VAR_USUARIO_REG	&lt;br/&gt;            WHERE ID_PRESUPUESTO=VAR_ID_PRESUP_INS;&lt;br/&gt;            &lt;br/&gt;        END IF;&lt;br/&gt;     END IF;&lt;br/&gt;	-- INICIA EL INGRESO DEL NUEVO PRESUPUESTO&lt;br/&gt;&lt;br/&gt;	INSERT INTO T_PRESUP (NOMB_PRESUP,ID_SEDE,FECHA_REG,USUARIO_REG,ULT_MODIF_FEC, ULT_MODIF_USER, FECHA_VAL_INI, FECHA_VAL_FIN,EST_ACTUAL)&lt;br/&gt;	VALUES&lt;br/&gt;	(VAR_NOMBRE,VAR_ID_SEDE,SYSDATE,VAR_USUARIO_REG,SYSDATE,VAR_USUARIO_REG,VAR_FECHA_DESDE,VAR_FECHA_HASTA,5)&lt;br/&gt;    RETURNING ID_PRESUPUESTO INTO VAR_ID_PRESUP_INS;	&lt;br/&gt;&lt;br/&gt;	-- INSERTA DETALLES DE PRESUPUESTO POR CADA TIPO DE PRESUPUESTO&lt;br/&gt;	INSERT INTO T_DET_PRESUP&lt;br/&gt;                      (ID_PRESUPUESTO, ID_TIPO, DET_P_FECHA_REG, DET_P_USR_REG, DET_P_ULT_MODIF_FEC, DET_P_MODIF_USR, DET_P_FECHA_VAL_INI, &lt;br/&gt;                      DET_P_FECHA_VAL_FIN, DET_P_EST_ACTUAL)&lt;br/&gt;	SELECT VAR_ID_PRESUP_INS,ID_TIPO_PRESUP,SYSDATE,VAR_USUARIO_REG,SYSDATE, VAR_USUARIO_REG, VAR_FECHA_DESDE, VAR_FECHA_HASTA, 5 FROM T_TIPO_PRESUP;&lt;br/&gt;&lt;br/&gt;	-- INSERTA UNA NUEVA VERSION EN CADA TIPO DE PRESUPUESTO Y CADA AREA&lt;br/&gt;&lt;br/&gt;	INSERT INTO T_VERSION&lt;br/&gt;                      (NRO, ID_DET_PRESUP, ID_AREA, V_FECHA_REG, V_USUARIO_REG, V_ULT_MODIF_FEC, V_ULT_MOD_USR, V_FECHA_VAL_INI, V_FECHA_VAL_FIN, &lt;br/&gt;                      EST_ACTUAL)&lt;br/&gt;	SELECT 1,A.ID_DET_PRESUP,B.ID_AREA,SYSDATE,VAR_USUARIO_REG,SYSDATE,VAR_USUARIO_REG,VAR_FECHA_DESDE,VAR_FECHA_HASTA,5&lt;br/&gt;	FROM T_DET_PRESUP A INNER JOIN T_AREA B ON B.ID_AREA=B.ID_AREA&lt;br/&gt;	WHERE A.ID_PRESUPUESTO=VAR_ID_PRESUP_INS;&lt;br/&gt;	&lt;br/&gt;	-- MUESTRA EL ULTIMO PRESUPUESTO CREADO&lt;br/&gt;	OPEN CUR_RPTA FOR&lt;br/&gt;	SELECT 1 AS RPTA FROM DUAL;&lt;br/&gt;&lt;br/&gt;EXCEPTION &lt;br/&gt;        WHEN OTHERS THEN&lt;br/&gt;&lt;br/&gt;            ROLLBACK TO obtenerResultados;&lt;br/&gt;            RAISE;&lt;br/&gt;END;</source>
<body>CREATE OR REPLACE PROCEDURE CONSULTOR3.NEW_PRESUP (&lt;br/&gt;  VAR_NOMBRE IN VARCHAR2, &lt;br/&gt;  VAR_ID_SEDE IN NUMBER, &lt;br/&gt;  VAR_USUARIO_REG IN VARCHAR2, &lt;br/&gt;  MES_DESDE IN NUMBER, &lt;br/&gt;  ANIO_DESDE IN NUMBER,&lt;br/&gt;  MES_HASTA IN NUMBER,&lt;br/&gt;  ANIO_HASTA IN NUMBER,&lt;br/&gt;  CUR_RPTA OUT SYS_REFCURSOR) AS&lt;br/&gt;  &lt;br/&gt;  VAR_NUMERO_PRESUPS NUMBER;&lt;br/&gt;  VAR_ID_PRESUP_INS NUMBER(22,0);&lt;br/&gt;  VAR_FECHA_DESDE DATE;&lt;br/&gt;  VAR_FECHA_HASTA DATE;&lt;br/&gt;  VAR_NEW_FECHA_HASTA DATE;&lt;br/&gt;&lt;br/&gt;BEGIN&lt;br/&gt;&lt;br/&gt;    SAVEPOINT obtenerResultados;&lt;br/&gt;	&lt;br/&gt;	--OBTIENE EL ULTIMO PRESUPUESTO&lt;br/&gt;    SELECT COUNT(ID_PRESUPUESTO) INTO VAR_NUMERO_PRESUPS &lt;br/&gt;    FROM T_PRESUP WHERE rownum &lt;= 5;&lt;br/&gt;    &lt;br/&gt;     -- OBTIENE LA FECHA DEL PRIMER DIA DEL MES Y AÃ`O PARA FECHA DE INICIO&lt;br/&gt;    SELECT TO_DATE(CONCAT(CONCAT(CONCAT(&apos;01/&apos;,MES_DESDE),&apos;/&apos;),ANIO_DESDE),&apos;dd/mm/yyyy&apos;) INTO VAR_FECHA_DESDE FROM DUAL;&lt;br/&gt;    -- OBTIENE LA FECHA DEL ULTIMO DIA DEL MES Y AÃ`O PARA FECHA DE FIN&lt;br/&gt;    SELECT LAST_DAY(TO_DATE(CONCAT(CONCAT(CONCAT(&apos;01/&apos;,MES_HASTA),&apos;/&apos;),ANIO_HASTA),&apos;dd/mm/yyyy&apos;)) INTO VAR_FECHA_HASTA FROM DUAL;&lt;br/&gt;    --OBTIENE LA FECHA CON EL ULTIMO DÃ¿A DEL MES ANTERIOR AL INICIO DEL PERIODO SOLICITADO&lt;br/&gt;    SELECT LAST_DAY(ADD_MONTHS(VAR_FECHA_DESDE,-1)) INTO VAR_NEW_FECHA_HASTA FROM DUAL;&lt;br/&gt;    &lt;br/&gt;    IF(VAR_NUMERO_PRESUPS&gt;0) THEN&lt;br/&gt;    &lt;br/&gt;        SELECT A.ID_PRESUPUESTO INTO VAR_ID_PRESUP_INS &lt;br/&gt;        FROM T_PRESUP A &lt;br/&gt;        WHERE A.FECHA_REG=(SELECT MAX(FECHA_REG) FROM T_PRESUP);&lt;br/&gt;        &lt;br/&gt;        IF(NVL(VAR_ID_PRESUP_INS,0)&lt;&gt;0) THEN&lt;br/&gt;    &lt;br/&gt;           &lt;br/&gt;        &lt;br/&gt;            -- ACTUALIZA EL ULTIMO PRESUPUESTO Y SUS DETALLES CON LAS FECHAS&lt;br/&gt;    &lt;br/&gt;            UPDATE T_VERSION&lt;br/&gt;            SET V_FECHA_VAL_FIN=VAR_NEW_FECHA_HASTA,&lt;br/&gt;            V_ULT_MODIF_FEC=SYSDATE,&lt;br/&gt;            V_ULT_MOD_USR=VAR_USUARIO_REG&lt;br/&gt;            where ID_VERSION IN &lt;br/&gt;            (SELECT A.ID_VERSION &lt;br/&gt;            FROM T_VERSION A &lt;br/&gt;            INNER JOIN T_DET_PRESUP B ON A.ID_DET_PRESUP=B.ID_DET_PRESUP&lt;br/&gt;            INNER JOIN T_PRESUP C ON B.ID_PRESUPUESTO=C.ID_PRESUPUESTO&lt;br/&gt;            WHERE C.ID_PRESUPUESTO=VAR_ID_PRESUP_INS);&lt;br/&gt;            &lt;br/&gt;            UPDATE T_DET_PRESUP&lt;br/&gt;            SET DET_P_FECHA_VAL_FIN=VAR_NEW_FECHA_HASTA,&lt;br/&gt;            DET_P_ULT_MODIF_FEC=SYSDATE,&lt;br/&gt;            DET_P_MODIF_USR=VAR_USUARIO_REG	&lt;br/&gt;            WHERE (ID_DET_PRESUP) IN(&lt;br/&gt;            SELECT&lt;br/&gt;            (B.ID_DET_PRESUP) &lt;br/&gt;            FROM&lt;br/&gt;            T_DET_PRESUP B &lt;br/&gt;            INNER JOIN T_PRESUP C ON B.ID_PRESUPUESTO=C.ID_PRESUPUESTO&lt;br/&gt;            WHERE C.ID_PRESUPUESTO=VAR_ID_PRESUP_INS);&lt;br/&gt;            &lt;br/&gt;            UPDATE T_PRESUP&lt;br/&gt;            SET FECHA_VAL_FIN=VAR_NEW_FECHA_HASTA,&lt;br/&gt;            ULT_MODIF_FEC=SYSDATE,&lt;br/&gt;            ULT_MODIF_USER=VAR_USUARIO_REG	&lt;br/&gt;            WHERE ID_PRESUPUESTO=VAR_ID_PRESUP_INS;&lt;br/&gt;            &lt;br/&gt;        END IF;&lt;br/&gt;     END IF;&lt;br/&gt;	-- INICIA EL INGRESO DEL NUEVO PRESUPUESTO&lt;br/&gt;&lt;br/&gt;	INSERT INTO T_PRESUP (NOMB_PRESUP,ID_SEDE,FECHA_REG,USUARIO_REG,ULT_MODIF_FEC, ULT_MODIF_USER, FECHA_VAL_INI, FECHA_VAL_FIN,EST_ACTUAL)&lt;br/&gt;	VALUES&lt;br/&gt;	(VAR_NOMBRE,VAR_ID_SEDE,SYSDATE,VAR_USUARIO_REG,SYSDATE,VAR_USUARIO_REG,VAR_FECHA_DESDE,VAR_FECHA_HASTA,5)&lt;br/&gt;    RETURNING ID_PRESUPUESTO INTO VAR_ID_PRESUP_INS;	&lt;br/&gt;&lt;br/&gt;	-- INSERTA DETALLES DE PRESUPUESTO POR CADA TIPO DE PRESUPUESTO&lt;br/&gt;	INSERT INTO T_DET_PRESUP&lt;br/&gt;                      (ID_PRESUPUESTO, ID_TIPO, DET_P_FECHA_REG, DET_P_USR_REG, DET_P_ULT_MODIF_FEC, DET_P_MODIF_USR, DET_P_FECHA_VAL_INI, &lt;br/&gt;                      DET_P_FECHA_VAL_FIN, DET_P_EST_ACTUAL)&lt;br/&gt;	SELECT VAR_ID_PRESUP_INS,ID_TIPO_PRESUP,SYSDATE,VAR_USUARIO_REG,SYSDATE, VAR_USUARIO_REG, VAR_FECHA_DESDE, VAR_FECHA_HASTA, 5 FROM T_TIPO_PRESUP;&lt;br/&gt;&lt;br/&gt;	-- INSERTA UNA NUEVA VERSION EN CADA TIPO DE PRESUPUESTO Y CADA AREA&lt;br/&gt;&lt;br/&gt;	INSERT INTO T_VERSION&lt;br/&gt;                      (NRO, ID_DET_PRESUP, ID_AREA, V_FECHA_REG, V_USUARIO_REG, V_ULT_MODIF_FEC, V_ULT_MOD_USR, V_FECHA_VAL_INI, V_FECHA_VAL_FIN, &lt;br/&gt;                      EST_ACTUAL)&lt;br/&gt;	SELECT 1,A.ID_DET_PRESUP,B.ID_AREA,SYSDATE,VAR_USUARIO_REG,SYSDATE,VAR_USUARIO_REG,VAR_FECHA_DESDE,VAR_FECHA_HASTA,5&lt;br/&gt;	FROM T_DET_PRESUP A INNER JOIN T_AREA B ON B.ID_AREA=B.ID_AREA&lt;br/&gt;	WHERE A.ID_PRESUPUESTO=VAR_ID_PRESUP_INS;&lt;br/&gt;	&lt;br/&gt;	-- MUESTRA EL ULTIMO PRESUPUESTO CREADO&lt;br/&gt;	OPEN CUR_RPTA FOR&lt;br/&gt;	SELECT 1 AS RPTA FROM DUAL;&lt;br/&gt;&lt;br/&gt;EXCEPTION &lt;br/&gt;        WHEN OTHERS THEN&lt;br/&gt;&lt;br/&gt;            ROLLBACK TO obtenerResultados;&lt;br/&gt;            RAISE;&lt;br/&gt;END;</body>
</StoredProcedureOraclev10g>